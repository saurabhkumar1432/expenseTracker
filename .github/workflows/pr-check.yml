name: Release PR Check

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  validate_release:
    name: Validate Release Readiness
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Verify Source Branch
        run: |
          echo "PR from: ${{ github.head_ref }}"
          if [[ "${{ github.head_ref }}" != "develop" ]]; then
            echo "‚ùå ERROR: Only 'develop' branch can be merged to 'main'"
            echo "Your branch: ${{ github.head_ref }}"
            echo "Please merge your changes to 'develop' first."
            exit 1
          fi
          echo "‚úÖ Source branch is 'develop' - proceeding with release validation"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run Full Test Suite
        run: ./gradlew ktlintCheck detekt lint test --parallel

      - name: Build Release APK (Unsigned)
        run: ./gradlew assembleRelease

      - name: Validate Version
        run: |
          VERSION_NAME=$(grep -oP 'versionName\s*=\s*"\K[^"]+' app/build.gradle.kts)
          VERSION_CODE=$(grep -oP 'versionCode\s*=\s*\K\d+' app/build.gradle.kts)
          echo "üì¶ Version: $VERSION_NAME ($VERSION_CODE)"
          
          # Check changelog exists for this version
          if [ ! -f "play-store/metadata/en-US/changelogs/${VERSION_CODE}.txt" ]; then
            echo "‚ö†Ô∏è WARNING: No changelog found for version code $VERSION_CODE"
            echo "Please create: play-store/metadata/en-US/changelogs/${VERSION_CODE}.txt"
          else
            echo "‚úÖ Changelog exists for version $VERSION_CODE"
          fi
