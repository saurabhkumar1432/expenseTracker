#!/bin/bash
# Pre-push hook - final safety check before pushing to remote
# Install: git config core.hooksPath .githooks

set -e

echo "ğŸš€ Running pre-push security checks..."

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

ERRORS_FOUND=0

# =============================================================================
# Check: Ensure no sensitive files are in the repository
# =============================================================================
echo "ğŸ” Scanning repository for sensitive files..."

SENSITIVE_FILES=(
    "^local\.properties$"
    "\.jks$"
    "\.keystore$"
    "^google-services\.json$"
    "^play-store-credentials\.json$"
    "\.p12$"
    "\.pem$"
    "^\.env$"
)

for pattern in "${SENSITIVE_FILES[@]}"; do
    # Exclude .example files from the check
    if git ls-files | grep -E "$pattern" | grep -v "\.example" | grep -q .; then
        echo -e "${RED}âŒ ERROR: Sensitive file tracked in repository: $pattern${NC}"
        git ls-files | grep -E "$pattern" | grep -v "\.example"
        ERRORS_FOUND=1
    fi
done

# =============================================================================
# Check: Scan for common secret patterns in all tracked files
# =============================================================================
echo "ğŸ” Scanning tracked files for secrets..."

# Check for Google API keys
if git grep -l 'AIza[0-9A-Za-z\-_]\{35\}' -- '*.kt' '*.java' '*.xml' 2>/dev/null; then
    echo -e "${RED}âŒ ERROR: Google API key found in tracked files${NC}"
    ERRORS_FOUND=1
fi

# Check for AWS keys
if git grep -l 'AKIA[0-9A-Z]\{16\}' 2>/dev/null; then
    echo -e "${RED}âŒ ERROR: AWS access key found in tracked files${NC}"
    ERRORS_FOUND=1
fi

# Check for private keys
if git grep -l '-----BEGIN.*PRIVATE KEY-----' 2>/dev/null; then
    echo -e "${RED}âŒ ERROR: Private key found in tracked files${NC}"
    ERRORS_FOUND=1
fi

# =============================================================================
# Final result
# =============================================================================
if [ $ERRORS_FOUND -eq 1 ]; then
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘  PUSH BLOCKED: Sensitive data detected!                    â•‘${NC}"
    echo -e "${RED}â•‘                                                            â•‘${NC}"
    echo -e "${RED}â•‘  Please remove sensitive files before pushing.             â•‘${NC}"
    echo -e "${RED}â•‘  Use: git rm --cached <file> to untrack files             â•‘${NC}"
    echo -e "${RED}â•‘                                                            â•‘${NC}"
    echo -e "${RED}â•‘  If this is a false positive, bypass with:                 â•‘${NC}"
    echo -e "${RED}â•‘  git push --no-verify                                      â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    exit 1
fi

echo -e "${GREEN}âœ… Pre-push security checks passed!${NC}"
exit 0
