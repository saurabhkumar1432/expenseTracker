# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#     https://docs.fastlane.tools/plugins/available-plugins

default_platform(:android)

platform :android do
  desc "Runs all the tests"
  lane :test do
    gradle(task: "test")
  end

  desc "Run lint checks"
  lane :lint do
    gradle(task: "lint")
    gradle(task: "ktlintCheck")
    gradle(task: "detekt")
  end

  desc "Build debug APK"
  lane :build_debug do
    gradle(
      task: "assembleDebug"
    )
  end

  desc "Build release APK"
  lane :build_release do
    gradle(
      task: "assembleRelease"
    )
  end

  desc "Build release AAB (App Bundle)"
  lane :build_bundle do
    gradle(
      task: "bundleRelease"
    )
  end

  # Helper method to get current version code from build.gradle.kts
  def get_version_code
    gradle_file = File.read("../app/build.gradle.kts")
    version_code = gradle_file.match(/versionCode\s*=\s*(\d+)/)[1].to_i
    version_code
  end

  # Helper method to check if changelog exists
  def ensure_changelog_exists(version_code)
    changelog_path = "../play-store/metadata/en-US/changelogs/#{version_code}.txt"
    default_path = "../play-store/metadata/en-US/changelogs/default.txt"
    
    unless File.exist?(changelog_path)
      if File.exist?(default_path)
        UI.message("ğŸ“ No changelog for #{version_code}, using default.txt")
        FileUtils.cp(default_path, changelog_path)
      else
        UI.message("ğŸ“ Creating default changelog for #{version_code}")
        File.write(changelog_path, "Bug fixes and performance improvements.")
      end
    end
  end

  desc "Deploy to internal testing track (triggered by develop branch)"
  lane :internal do
    version_code = get_version_code
    UI.message("ğŸ“¦ Deploying version code: #{version_code} to INTERNAL")
    
    ensure_changelog_exists(version_code)
    
    # Build the release AAB
    gradle(task: "bundleRelease")
    
    # Upload to Play Store internal track with metadata
    upload_to_play_store(
      track: "internal",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      metadata_path: "./play-store/metadata",
      release_status: "completed",
      version_code: version_code
    )
    
    UI.success("âœ… Successfully deployed to Internal track!")
  end

  desc "Deploy to alpha testing track"
  lane :alpha do
    version_code = get_version_code
    UI.message("ğŸ“¦ Deploying version code: #{version_code} to ALPHA")
    
    ensure_changelog_exists(version_code)
    
    gradle(task: "bundleRelease")
    
    upload_to_play_store(
      track: "alpha",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      metadata_path: "./play-store/metadata",
      release_status: "completed",
      version_code: version_code
    )
    
    UI.success("âœ… Successfully deployed to Alpha track!")
  end

  desc "Deploy to beta testing track (triggered by GitHub prerelease)"
  lane :beta do
    version_code = get_version_code
    UI.message("ğŸ“¦ Deploying version code: #{version_code} to BETA")
    
    ensure_changelog_exists(version_code)
    
    gradle(task: "bundleRelease")
    
    upload_to_play_store(
      track: "beta",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      metadata_path: "./play-store/metadata",
      release_status: "completed",
      version_code: version_code
    )
    
    UI.success("âœ… Successfully deployed to Beta track!")
  end

  desc "Deploy to production (triggered by GitHub release)"
  lane :production do
    version_code = get_version_code
    UI.message("ğŸš€ Deploying version code: #{version_code} to PRODUCTION")
    
    ensure_changelog_exists(version_code)
    
    gradle(task: "bundleRelease")
    
    upload_to_play_store(
      track: "production",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      metadata_path: "./play-store/metadata",
      release_status: "completed",
      version_code: version_code
    )
    
    UI.success("ğŸ‰ Successfully deployed to Production!")
  end

  desc "Promote internal to beta"
  lane :promote_internal_to_beta do
    upload_to_play_store(
      track: "internal",
      track_promote_to: "beta",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: false
    )
    
    UI.success("âœ… Promoted from Internal to Beta!")
  end

  desc "Promote beta to production"
  lane :promote_beta_to_production do
    upload_to_play_store(
      track: "beta",
      track_promote_to: "production",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: false
    )
    
    UI.success("ğŸ‰ Promoted from Beta to Production!")
  end

  desc "Upload metadata and screenshots only (no build)"
  lane :metadata do
    upload_to_play_store(
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      metadata_path: "./play-store/metadata"
    )
    
    UI.success("âœ… Metadata and assets uploaded!")
  end

  desc "Validate metadata without uploading"
  lane :validate do
    gradle(task: "bundleRelease")
    
    upload_to_play_store(
      track: "internal",
      validate_only: true,
      aab: "app/build/outputs/bundle/release/app-release.aab",
      metadata_path: "./play-store/metadata"
    )
    
    UI.success("âœ… Validation passed!")
  end

  # Error handling
  error do |lane, exception|
    UI.error("âŒ Error in lane #{lane}: #{exception.message}")
  end
end
