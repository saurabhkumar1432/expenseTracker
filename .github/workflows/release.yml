name: Release

on:
  push:
    branches:
      - main
    paths:
      - "app/**"
      - "build.gradle.kts"
      - "settings.gradle.kts"
      - "gradle/**"
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

env:
  JAVA_VERSION: "17"
  JAVA_DISTRIBUTION: "temurin"

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Extract version
        id: version
        run: |
          VERSION_NAME=$(grep 'versionName' app/build.gradle.kts | head -1 | cut -d'"' -f2)
          VERSION_CODE=$(grep 'versionCode' app/build.gradle.kts | head -1 | grep -oE '[0-9]+')
          echo "name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION_NAME" >> $GITHUB_OUTPUT

      - name: Check existing release
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if gh release view "${{ steps.version.outputs.tag }}" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Decode Keystore
        if: steps.check.outputs.exists == 'false'
        env:
            ENCODED_STRING: ${{ secrets.SIGNING_KEYSTORE_BASE64 }}
        run: |
            if [ ! -z "$ENCODED_STRING" ]; then
              echo $ENCODED_STRING | base64 -d > app/release.keystore
            fi

      - name: Run checks
        if: steps.check.outputs.exists == 'false'
        run: ./gradlew lintRelease testReleaseUnitTest --parallel

      - name: Build APK
        if: steps.check.outputs.exists == 'false'
        env:
          SIGNING_KEYSTORE_PATH: app/release.keystore
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
        run: ./gradlew assembleRelease

      - name: Prepare APK
        if: steps.check.outputs.exists == 'false'
        id: apk
        run: |
          APK=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          FINAL="app/build/outputs/apk/release/ExpenseTracker-${{ steps.version.outputs.tag }}.apk"
          mv "$APK" "$FINAL"
          echo "path=$FINAL" >> $GITHUB_OUTPUT
          echo "size=$(du -h $FINAL | cut -f1)" >> $GITHUB_OUTPUT
          echo "sha=$(sha256sum $FINAL | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Generate notes
        if: steps.check.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.name }}"
          TAG="${{ steps.version.outputs.tag }}"
          
          awk -v ver="$VERSION" '
            /^## \[/ { if (found) exit; if (index($0, "[" ver "]")) found=1 }
            found
          ' CHANGELOG.md > notes.md
          
          if [ ! -s notes.md ]; then
            echo "## Release $TAG" > notes.md
            echo "" >> notes.md
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> notes.md
          fi
          
          cat >> notes.md << 'NOTES_EOF'
          
          ---
          
          ### Download Info
          
          | Property | Value |
          |----------|-------|
          | **Size** | ${{ steps.apk.outputs.size }} |
          | **Min SDK** | 24 (Android 7.0) |
          | **Target SDK** | 34 (Android 14) |
          | **Version Code** | ${{ steps.version.outputs.code }} |
          
          <details>
          <summary>SHA-256</summary>
          
          ```
          ${{ steps.apk.outputs.sha }}
          ```
          </details>
          NOTES_EOF

      - name: Create release
        if: steps.check.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ExpenseTracker ${{ steps.version.outputs.tag }}
          body_path: notes.md
          files: ${{ steps.apk.outputs.path }}
          draft: true
          prerelease: ${{ contains(steps.version.outputs.name, '-') }}

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check.outputs.exists }}" == "true" ]; then
            echo "### Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Release ${{ steps.version.outputs.tag }} already exists." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Released" >> $GITHUB_STEP_SUMMARY
            echo "Version: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          fi
